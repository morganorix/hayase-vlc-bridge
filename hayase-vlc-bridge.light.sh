#!/usr/bin/env bash
set -Eeuo pipefail; V="1.1.0"; unset HAYASE_LOG_LEVEL HAYASE_LOG_ENABLED HAYASE_LOG_VERBOSITY; E="${HAYASE_ENV_FILE:-$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")"&&pwd)/.env}"; S(){ local f="$1"; [[ -f "$f" ]]||return 0; set -a; source "$f"; set +a; }; S "$E"; : "${LOG_VERBOSITY:=0}"; : "${LOG_DIR:="${HOME}/.local/logs/"}"; LOG_DIR="${LOG_DIR%/}/"; : "${LOG_FILE:="${LOG_DIR%/}/hayase-vlc-bridge.log"}"; : "${REMOTE_HOST:=}"; : "${WS_URL:="ws://${REMOTE_HOST}"}"; : "${STREAM_HOST:=}"; : "${VLC_LOCAL_CMD:="flatpak run org.videolan.VLC --one-instance"}"; T(){ date -Is; }; e(){ [[ "${LOG_VERBOSITY:-0}" -ge 1 ]]; }; d(){ [[ "${LOG_VERBOSITY:-0}" -ge 2 ]]; }; L(){ local k="$1"; shift; e||return 0; printf '[%s] %-5s %s\n' "$(T)" "$k" "$*" >>"$LOG_FILE"; }; D(){ d&&L DEBUG "$*"||true; }; W(){ L WARN "$*"; printf 'WARN: %s\n' "$*" >&2; }; Z(){ L INFO "END"; }; X(){ L ERROR "$1"; printf 'ERROR: %s\n' "$1" >&2; Z; exit 1; }; M(){ local s="${1-}"; [[ -z "$s" ]]&&{ printf '<e>'; return; }; local n=${#s}; ((n<=4))&&printf '****'||((n<=8))&&printf '%s****' "${s:0:2}"||printf '%s****%s' "${s:0:4}" "${s: -2}"; }; C(){ if d; then local q="E=$(M "$E") LV=${LOG_VERBOSITY:-} LD=$(M "$LOG_DIR") LF=$(M "$LOG_FILE") RH=$(M "$REMOTE_HOST") WU=$(M "$WS_URL") SH=$(M "$STREAM_HOST") VLC=$(M "$VLC_LOCAL_CMD")"; D "$q"; printf '%s\n' "$q" >&2; else e&&L INFO "CFG OK"||true; fi; }; F(){ W "$1"; D "R=<${R:-}>"; Z; exec python3 -c 'import os,shlex,sys; a=shlex.split(os.environ.get("VLC_LOCAL_CMD","vlc")); os.execvp(a[0], a+[sys.argv[1]])' "$R"; }; N(){ python3 -c 'import json,sys,urllib.parse as p; u=p.unquote(sys.argv[1]); u=p.quote(u,safe=":/%?=&"); print(u); print(json.dumps({"type":"openURL","url":u}))' "$1"; }; e&&mkdir -p "$LOG_DIR" 2>/dev/null||true; e&&L INFO "START v$V"; C; [[ -n "${LOG_DIR:-}" ]]||X "LOG_DIR empty"; [[ -n "${LOG_FILE:-}" ]]||X "LOG_FILE empty"; [[ -n "${REMOTE_HOST:-}" ]]||X "REMOTE_HOST empty"; [[ -n "${STREAM_HOST:-}" ]]||X "STREAM_HOST empty"; [[ -n "${WS_URL:-}" ]]||X "WS_URL empty"; command -v python3 >/dev/null 2>&1||X "python3 missing"; command -v curl >/dev/null 2>&1||X "curl missing"; [[ $# -ge 1 ]]||X "no url"; R="$*"; D "RAW=<${R}>"; [[ "$R" == *"://"* ]]||X "bad url"; t="${R/http:\/\/localhost:/http:\/\/$STREAM_HOST:}"; t="${t/http:\/\/127.0.0.1:/http:\/\/$STREAM_HOST:}"; mapfile -t a < <(N "$t")||X "norm fail"; u="${a[0]:-}"; j="${a[1]:-}"; [[ -n "$u" && -n "$j" ]]||X "norm empty"; D "URL=<${u}>"; curl -fsS --connect-timeout 0.3 --max-time 0.8 "http://${REMOTE_HOST}/" >/dev/null 2>&1||F "remote down"; command -v websocat >/dev/null 2>&1||F "websocat missing"; r="$(printf '%s\n' "$j" | websocat -n1 "$WS_URL" 2>&1)"||F "ws send fail"; L INFO "RESP=<${r}>"; shopt -s nocasematch; if [[ "$r" == *"invalid request"* || "$r" == *"error"* || "$r" == *"failed"* ]]; then shopt -u nocasematch; F "ws resp error"; fi; shopt -u nocasematch; Z; exit 0

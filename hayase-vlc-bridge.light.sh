#!/usr/bin/env bash
set -Eeuo pipefail; VERSION="1.1.0"; unset HAYASE_LOG_LEVEL HAYASE_LOG_ENABLED HAYASE_LOG_VERBOSITY; ENV_FILE="${HAYASE_ENV_FILE:-$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)/.env}"; load_env(){ local f="$1"; [[ -f "$f" ]] || return 0; set -a; source "$f"; set +a; }; load_env "$ENV_FILE"; : "${LOG_VERBOSITY:=0}"; : "${LOG_DIR:="${HOME}/.local/logs/"}"; LOG_DIR="${LOG_DIR%/}/"; : "${LOG_FILE:="${LOG_DIR%/}/hayase-vlc-bridge.log"}"; : "${REMOTE_HOST:=}"; : "${WS_URL:="ws://${REMOTE_HOST}"}"; : "${STREAM_HOST:=}"; : "${VLC_LOCAL_CMD:="flatpak run org.videolan.VLC --one-instance"}"; mapfile -t VLC_LOCAL < <(python3 -c 'import os,shlex;print("\n".join(shlex.split(os.environ.get("VLC_LOCAL_CMD",""))))'); ts(){ date -Is; }; le(){ [[ "${LOG_VERBOSITY:-0}" -ge 1 ]]; }; ld(){ [[ "${LOG_VERBOSITY:-0}" -ge 2 ]]; }; log(){ local lvl="$1"; shift; le || return 0; printf '[%s] %-5s %s\n' "$(ts)" "$lvl" "$*" >>"$LOG_FILE"; }; dbg(){ ld && log DEBUG "$*" || true; }; warn(){ log WARN "⚠ $*"; printf 'WARN: %s\n' "$*" >&2; }; sep(){ le && printf '============================================================\n' >>"$LOG_FILE" || true; }; endblk(){ log INFO "===== END ====="; sep; }; fail(){ log ERROR "✗ $*"; printf 'ERROR: %s\n' "$*" >&2; endblk; exit 1; }; mask(){ local s="${1-}"; [[ -z "$s" ]] && { printf '<empty>'; return; }; local n=${#s}; ((n<=4)) && printf '****' || ((n<=8)) && printf '%s****' "${s:0:2}" || printf '%s****%s' "${s:0:4}" "${s: -2}"; }; dumpcfg(){ if ld; then local d="ENV_FILE=$(mask "$ENV_FILE") LOG_VERBOSITY=${LOG_VERBOSITY:-} LOG_DIR=$(mask "$LOG_DIR") LOG_FILE=$(mask "$LOG_FILE") REMOTE_HOST=$(mask "$REMOTE_HOST") WS_URL=$(mask "$WS_URL") STREAM_HOST=$(mask "$STREAM_HOST") VLC_LOCAL_CMD=$(mask "$VLC_LOCAL_CMD")"; dbg "$d"; printf '%s\n' "$d" >&2; else le && log INFO "✓ External variables loaded: OK." || true; fi; }; fallback(){ warn "$1"; warn "Fallback: launching local VLC."; dbg "URL(local)=<${RAW_TARGET:-}>"; endblk; exec "${VLC_LOCAL[@]}" "${RAW_TARGET}"; }; normjson(){ python3 -c 'import json,sys,urllib.parse;u=urllib.parse.unquote(sys.argv[1]);u=urllib.parse.quote(u,safe=":/%?=&");print(u);print(json.dumps({"type":"openURL","url":u}))' "$1"; }; le && mkdir -p "$LOG_DIR" 2>/dev/null || true; sep; log INFO "Hayase VLC Bridge v${VERSION}"; log INFO "===== START ====="; dbg "CONFIG: LOG_VERBOSITY=$LOG_VERBOSITY STREAM_HOST=$STREAM_HOST REMOTE_HOST=$REMOTE_HOST"; dumpcfg; [[ -n "${REMOTE_HOST:-}" ]] || fail "REMOTE_HOST is not configured (empty). Set it in .env or in the script."; [[ -n "${STREAM_HOST:-}" ]] || fail "STREAM_HOST is not configured (empty). Set it in .env or in the script."; [[ -n "${LOG_DIR:-}" ]] || fail "LOG_DIR is not configured (empty). Set it in .env or in the script."; [[ -n "${WS_URL:-}" ]] || fail "WS_URL is empty. Set it in .env or in the script."; command -v python3 >/dev/null 2>&1 || fail "python3 is required for URL normalization."; command -v curl >/dev/null 2>&1 || fail "curl is required to check remote VLC."; [[ $# -ge 1 ]] || fail "Stream retrieval failed: no URL provided."; RAW_TARGET="$*"; dbg "URL(raw)=<${RAW_TARGET}>"; [[ "$RAW_TARGET" == *"://"* ]] || fail "Invalid stream source: argument is not a valid URL."; target="$RAW_TARGET"; target="${target/http:\/\/localhost:/http:\/\/$STREAM_HOST:}"; target="${target/http:\/\/127.0.0.1:/http:\/\/$STREAM_HOST:}"; dbg "URL(rewrite-host)=<$target>"; mapfile -t __n < <(normjson "$target") || fail "Malformed stream: URL normalization failed."; target="${__n[0]:-}"; json_cmd="${__n[1]:-}"; [[ -n "$target" ]] || fail "Malformed stream: empty URL after normalization."; [[ -n "$json_cmd" ]] || fail "Malformed stream: empty JSON after normalization."; log INFO "URL(final)=<$target>"; curl -fsS --connect-timeout 0.3 --max-time 0.8 "http://${REMOTE_HOST}/" >/dev/null 2>&1 || fallback "Remote VLC server unreachable (http://${REMOTE_HOST}/)."; command -v websocat >/dev/null 2>&1 || fallback "websocat missing (cannot send to remote VLC)."; dbg "WS url=<$WS_URL>"; dbg "WS json=<$json_cmd>"; resp="$(printf '%s\n' "$json_cmd" | websocat -n1 "$WS_URL" 2>&1)" || fallback "WebSocket transmission failed."; log INFO "VLC response=<$resp>"; shopt -s nocasematch; if [[ "$resp" == *"INVALID REQUEST"* || "$resp" == *"error"* || "$resp" == *"failed"* ]]; then shopt -u nocasematch; fallback "WebSocket response indicates an error."; fi; shopt -u nocasematch; endblk; exit 0
